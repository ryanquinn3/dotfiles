# Git commit all with message, retrying if pre-commit hooks fail
gacm(){
  if [ -z "$1" ]; then
    echo "Please provide a commit message"
    return 1
  fi

  echo "Committing code..."

  git add --all
  
  # if this fails, retry
  git commit -m $1
  if [ $? -ne 0 ]; then
    echo "Pre commit hooks may have failed... retrying..."
    git add --all
    git commit -m $1
  fi
}

# Use fzf to interactively select and checkout a git branch
_change_branch(){
  git branch --sort=-committerdate | \
  fzf  --border rounded --ansi \
       --preview 'git show --color=always --compact-summary {-1}' \
      --bind 'enter:become(git checkout {-1})'
}


# Fetch and update local branch from remote
syncb() {
  local default_branch=$(git remote show origin | grep 'HEAD branch' -m 1 | cut -d' ' -f5)
  local branch="${1:-$default_branch}"
  git fetch origin $branch:$branch --update-head-ok --no-tags
}

# Delete git branches matching a substring
gitdb() {
  if [ -z "$1" ]
  then
    echo "Provide a git branch substring to delete it"
    exit 0
  fi
  git branch | grep -Ei "$1" | grep -Eiv "\*" | while read -r line ; do
    gb -D $line
  done
}

# Smart Git Squash Function
git_smart_squash() {
  local target_branch=$1
  local current_head=$(git rev-parse --short HEAD)

  # 1. Check if a branch/commit was provided
  if [[ -z "$target_branch" ]]; then
    echo "Usage: git-squash-all <base-branch>"
    return 1
  fi

  # 2. Identify the merge base
  local merge_base=$(git merge-base HEAD "$target_branch")
  local target_rev=$(git rev-parse "$target_branch")

  echo "Original HEAD: $current_head"

  # 3. Warning if the provided branch is not the merge base
  if [[ "$merge_base" != "$target_rev" ]]; then
    echo "⚠️  WARNING: '$target_branch' is not the direct merge base of your current branch."
    echo "The merge base is actually: $(git rev-parse --short $merge_base)"
    echo -n "Do you want to proceed with squashing against the merge base? (y/n): "
    read -q "choice"
    echo "" # Move to new line
    if [[ "$choice" != "y" ]]; then
      echo "Aborting."
      return 1
    fi
  fi

  # 4. Perform the squash
  echo "Squashing all commits since $merge_base..."
  git reset --soft "$merge_base"
  
  echo "Ready to commit. Use 'git commit' to finalize."
}
